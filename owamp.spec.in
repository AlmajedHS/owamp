## NOTE: owamp.spec is autogenerated from owamp.spec.in . Edit the latter,
## not the former.

## Things that need to be edited frequently
#
# This should be incremented whenever the spec file changes, but
# can drop back to zero at a new Owamp version

%define specver 0

## Things users may want to change
#
# User (and group) name under which the Owamp daemon runs.

%define owampuser @OWAMPUSER@
%define owampgroup @OWAMPGROUP@

## Target a specific arch and OS
#
# default is i386 linux
%define target gnu
%define target_cpu i386
%define target_os linux

## Override any system rpm macros
#
%define _arch %{target_cpu}
%define _build_arch %{target_cpu}
%define _vendor %{target_os}
%define _host %{target_cpu}-pc-%{target_os}-%{target}
%define _host_cpu %{target_cpu}
%define _host_vendor %{target_os}
%define optflags -march=%{target_cpu} -mtune=%{target_cpu} -O2

## Version song and dance
#
# This should be the Owamp version number, as it appears on the tarball,
# including any "pre<x>" or "rc<y>" suffix. This gets massaged to
# create the RPM version number, in a way that depends on the Owamp
# numbering scheme.
%define native_version       @VERSION@

%define version %(echo %{native_version} | sed -e 's/-/./g')

## Define output filename
#
# This creates filenames based upon the value of target_cpu defined above
%define _build_name_fmt %%{NAME}-%%{VERSION}-%%{RELEASE}.%{target_cpu}.rpm

## Release and OS identification song and dance
#
# This identifies the lineage of the spec file. This file is the
# standard one that comes with Owamp; various distributions may
# have their own ideas about the right ways to do things.
%define pkgspec owamp

# This spec is intended to build and install on multiple distributions
# (someday). Detect the distribution we're building on.

%define is_rh   %(test -e /etc/redhat-release && echo 1 || echo 0)
%define is_fc   %(test -e /etc/fedora-release && echo 1 || echo 0)
%define is_mdk  %(test -e /etc/mandrake-release && echo 1 || echo 0)
%define is_suse %(test -e /etc/SuSE-release && echo 1 || echo 0)

%if %{is_fc}
%define ostag %(sed -e 's/^.*release /fc/' -e 's/ .*$//' -e 's/\\./_/g' < /etc/fedora-release)
%else
%if %{is_rh}
%define ostag %(sed -e 's/^.*release /rh/' -e 's/ .*$//' -e 's/\\./_/g' < /etc/redhat-release)
%endif
%endif

# These are probably wrong... just placeholders should we actually
# end up supporting these distributions

%if %{is_mdk}
%define ostag mdk
%endif

%if %{is_suse}
%define ostag suse
%endif

# Using the build date ensures that every build really does get
# a different release number.  We use this trick for CVS versions.
# For release versions, we don't want or need it.
%define is_dev_version %(echo %{native_version} | grep 'dev' > /dev/null && echo 1 || echo 0)

%if %{is_dev_version}
%define blddate %(date -u +"%Y%m%d%H%M")
%define release %{pkgspec}.%{specver}.%{ostag}.%{blddate}
%else
%define release %{pkgspec}.%{specver}.%{ostag}
%endif

## General-purpose macros
#
# Some systems don't have some macros. If a macro doesn't seem
# to exist on your system, add it here...

%if %{!?__make:1}%{?__make:0}
%define __make make
%endif

%if %{!?make:1}%{?make:0}
%define make %{__make}
%endif

%if %{!?_localstatedir:1}%{?_localstatedir:0}
%define _localstatedir @LOCALSTATEDIR@
%endif

## Package information
#
Name: owamp
Version: %{version}
Release: %{release}

Summary: One-way Latency Measurement Tool
URL: http://e2epi.internet2.edu/owamp
Group: System Environment/Daemons

License: BSD-like
Vendor: Internet2 E2E PI
Packager: owamp-rel@internet2.edu

%if %{is_suse}
Requires: openssl >= 0.9.6
BuildRequires: openssl-devel >= 0.9.6, rpm >= 4.0, zlib-devel
%else
Requires: openssl >= 0.9.6
BuildRequires: openssl-devel >= 0.9.6, libevent-devel >= 1.2
%endif
%if %{is_fc}
BuildRequires: rpm-build >= 4.0
%endif
Requires(pre): /usr/bin/id, /bin/date, /bin/sh
Requires(pre): %{_sbindir}/useradd, %{_sbindir}/groupadd

Source0: http://e2epi.internet2.edu/dist/%{name}-%{native_version}.tar.gz

BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root

%description
OWAMP is a command line client application and a policy daemon used to determine one way latencies between hosts. It is an implementation of the OWAMP protocol as defined by http://www.rfc-editor.org/rfc/rfc4656.txt.

%prep
%setup -q -n %{name}-%{native_version}

%build
%if %{is_suse}
%configure --with-owamp-user=%{owampuser} --with-owamp-group=%{owampgroup} \
	--build=%{_host} --host=%{_host} --target=%{_host} \
	--enable-static --disable-shared
%else
%configure --with-owamp-user=%{owampuser} --with-owamp-group=%{owampgroup} \
	--build=%{_host} --host=%{_host} --target=%{_host}
%endif
%make

%install
%makeinstall

# Install init script and control script
%__mkdir_p ${RPM_BUILD_ROOT}%{_initrddir}
%if %{is_suse}
%__install -p -m 755 contrib/suse/owamp.sh ${RPM_BUILD_ROOT}%{_initrddir}/%{name}
%else
%__install -p -m 755 contrib/owamp.sh ${RPM_BUILD_ROOT}%{_initrddir}/%{name}
%endif
%__install -p -m 755 contrib/owampctl ${RPM_BUILD_ROOT}%{_bindir}

# Set up config file; "sample" file implements a basic user node.
%__install -p -m 644 ${RPM_BUILD_ROOT}%{_sysconfdir}/%{name}/owamprc.sample ${RPM_BUILD_ROOT}%{_sysconfdir}/%{name}/owamprc

# Install the logrotate control file.
%__mkdir_p -m 755 ${RPM_BUILD_ROOT}%{_sysconfdir}/logrotate.d
%__install -p -m 644 contrib/owamp.logrotate ${RPM_BUILD_ROOT}%{_sysconfdir}/logrotate.d/%{name}

# Directories that don't have any preinstalled files
%__mkdir_p -m 700 ${RPM_BUILD_ROOT}%{_localstatedir}/lib/%{name}
%__mkdir_p -m 755 ${RPM_BUILD_ROOT}%{_localstatedir}/run/%{name}
%__mkdir_p -m 755 ${RPM_BUILD_ROOT}%{_localstatedir}/log/%{name}
%__mkdir_p -m 700 ${RPM_BUILD_ROOT}%{_localstatedir}/tmp/%{name}

%clean
[ "${RPM_BUILD_ROOT}" != "/" ] && rm -rf ${RPM_BUILD_ROOT}

# These scripts are probably wrong for Mandrake or SuSE. They're certainly
# wrong for Debian, but what are you doing using RPM on Debian?

%pre

# If owamp is already installed and running (whether installed by RPM
# or not), then kill it, but remember that it was running.
%__rm -f /%{_localstatedir}/tmp/${name}-was-running-%{version}-%{release}
if [ -f %{_initrddir}/%{name} ] && /sbin/service %{name} status ; then
    /sbin/service %{name} stop
    touch /%{_localstatedir}/tmp/${name}-was-running-%{version}-%{release}
fi

#
# Create a user and group if need be
#
if [ ! -n "`/usr/bin/id -g %{owampgroup} 2>/dev/null`" ]; then
    # One would like to default the GID, but doing that properly would
    # require thought.
    %{_sbindir}/groupadd %{owampgroup} 2> /dev/null
fi
if [ ! -n "`/usr/bin/id -u %{owampuser} 2>/dev/null`" ]; then
    # One would also like to default the UID, but doing that properly would
    # also require thought.
    if [ -x %{_sbindir}/nologin ]; then
        %{_sbindir}/useradd -r -g %{owampgroup} -d% {_localstatedir}/lib/%{name} -s %{_sbindir}/nologin %{owampuser} 2> /dev/null
    else
        %{_sbindir}/useradd -r -g %{owampgroup} -d %{_localstatedir}/lib/%{name}  -s /bin/false %{owampuser} 2> /dev/null
    fi
fi
exit 0

%post

# If this is a new installation, use chkconfig to put owamp in the
# default set of runlevels. If it's an upgrade, leave the existing
# configuration alone.
if [ $1 -eq 1 ]; then
    /sbin/chkconfig --add %{name}
    /sbin/chkconfig %{name} on
fi

# Older owamp RPMS used a different username for the owamp daemon.
# Make sure the runtime data have the right ownership.
%__chown -R %{owampuser}.%{owampgroup} %{_localstatedir}/{lib,log,run}/%{name}

if [ -f /%{_localstatedir}/tmp/${name}-was-running-%{version}-%{release} ]; then
    /sbin/service %{name} start
    %__rm -f /%{_localstatedir}/tmp/${name}-was-running-%{version}-%{release}
fi
exit 0

%preun

# If no instances of owamp will be installed when we're done, make
# sure that it gets killed. We *don't* want to kill it or delete
# any of its data on uninstall if it's being upgraded to a new
# version, because the new version will actually already have
# been installed and started before the uninstall script for
# the old version is run, and we'd end up hosing it.
if [ $1 -le 0 ]; then
    if [ -f %{_initrddir}/%{name} ] && /sbin/service %{name} status ; then
        /sbin/service %{name} stop
    fi
    %/sbin/chkconfig --del %{name}
    %__rm -f ${_localstatedir}/lib/%{name}/cached-directory
    %__rm -f ${_localstatedir}/lib/%{name}/bw_accounting
    %__rm -f ${_localstatedir}/lib/%{name}/control_auth_cookie
    %__rm -f ${_localstatedir}/lib/%{name}/router.desc
    %__rm -f ${_localstatedir}/lib/%{name}/fingerprint
fi
exit 0

%files
%defattr(-,root,root)

#%doc AUTHORS INSTALL LICENSE README ChangeLog doc/HACKING doc/TODO
#%{_mandir}/man*/*
#%{_bindir}/owamp
#%{_bindir}/owampctl
#%{_bindir}/owampify
#%{_bindir}/owamp-resolve
#%config %{_initrddir}/%{name}
#%config(noreplace) %attr(0644,root,root) %{_sysconfdir}/logrotate.d/%{name}
#%dir %attr(0755,root,%{owampgroup}) %{_sysconfdir}/%{name}/
#%config(noreplace) %attr(0644,root,%{owampgroup}) %{_sysconfdir}/%{name}/*
#%attr(0700,%{owampuser},%{owampgroup}) %dir %{_localstatedir}/lib/%{name}
#%attr(0750,%{owampuser},%{owampgroup}) %dir %{_localstatedir}/run/%{name}
#%attr(0750,%{owampuser},%{owampgroup}) %dir %{_localstatedir}/log/%{name}


/usr/local/bin/aespasswd
/usr/local/bin/owampd
/usr/local/bin/owping
/usr/local/bin/owtvec
/usr/local/bin/powstream

/usr/local/lib/libI2util.a
/usr/local/lib/libowamp.a

%doc %attr(0444,root,root) /usr/local/man/man1/aespasswd.1
%doc %attr(0444,root,root) /usr/local/man/man1/owfetch.1
%doc %attr(0444,root,root) /usr/local/man/man1/owping.1
%doc %attr(0444,root,root) /usr/local/man/man1/owstats.1
%doc %attr(0444,root,root) /usr/local/man/man1/owup.1

%doc %attr(0444,root,root) /usr/local/man/man5/owampd.conf.5
%doc %attr(0444,root,root) /usr/local/man/man5/owampd.keys.5
%doc %attr(0444,root,root) /usr/local/man/man5/owampd.limits.5

%doc %attr(0444,root,root) /usr/local/man/man8/owampd.8

#%postun
#rm -f /usr/local/bin/owfetch
#rm -f /usr/local/bin/owstats
#rm -f /usr/local/bin/owup

%changelog

* March 12 2007 Warren Matthews <warren.matthews@oit.gatech.edu>
- Basic spec file created from tor.spec.in
- Untested.
