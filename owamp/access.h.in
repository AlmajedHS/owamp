/*
 * $Id$
 */
#ifndef	_owamp_contrib_h_
#define	_owamp_contrib_h_
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <limits.h>
#include <math.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <assert.h>
#include <netdb.h>
#include <errno.h>
#include <sys/wait.h>
#include <syslog.h>
#include <stdarg.h>

/* for inet_pton */
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

/* for ntohl */
#include <sys/param.h>

#include <I2util/table.h>
#include <owamp/owamp.h>

#ifndef	OWP_PREFIX
#define	OWP_PREFIX	/usr/local
#endif

#undef	AUTOCONF_SYSCONFDIR
#define	MSTRCAT(A,B)		#A ## #B
#define	MSTRCATEXPAND(A,B)	MSTRCAT(A,B)
#define	OWP_CONFDIR		MSTRCATEXPAND(OWP_PREFIX,AUTOCONF_SYSCONFDIR)

#define MAX_LINE 1024

#ifndef MAXPATHLEN
#define MAXPATHLEN 1024
#endif

#define OWP_KID_LEN 16
#define OWP_PASSWD_LEN 16
#define OWP_HEX_PASSWD_LEN (OWP_PASSWD_LEN * 2)
#define OWP_MAX_CLASS_LEN 32

typedef u_int64_t owp_lim_t;

/*
** This structure is used to keep track of usage resources.
*/
typedef struct owamp_limits {
	owp_lim_t values[6];   
} owp_lim;

/*
** Inidices to refer to particular limits/attributes.
*/
#define OWP_LIM_BANDWIDTH 0      /* bandwidth - octets/sec */
#define OWP_LIM_SPACE     1 	 /* disk space - octets    */
#define OWP_LIM_EXPIRY    2      /* expiry offset - sec    */
#define OWP_LIM_DOC       3      /* delete-on-close flag   */
#define OWP_LIM_DOF       4      /* delete-on-fetch flag   */
#define OWP_LIM_OPEN_OK   5      /* open_mode-ok flag      */

typedef struct owp_tree_node *owp_tree_node_ptr;

typedef struct owp_tree_node {
	char* data;
	owp_tree_node_ptr next_sibling;
	owp_tree_node_ptr first_child;
	owp_tree_node_ptr parent;
	owp_lim           limits;
} owp_tree_node;

typedef struct {
	I2table ip2class;
	I2table class2node;
	I2table passwd;
	owp_tree_node_ptr root; /* Root class of the tree hierarchy. */
} policy_data;

typedef struct owp_access_id {
	u_int32_t addr4;
	u_int8_t  addr6[16];
	u_int8_t  offset;                       /* not meaningful for KID */
	char      kid[OWP_KID_LEN + 1];
	int    type;  /* OWP_IDTYPE_KID, OWP_IDTYPE_IPv4, OWP_IDTYPE_IPv6 */
} owp_access_id;

typedef struct owp_access_netmask {
	u_int32_t addr4;            /* In host byte order. */
	u_int8_t  addr6[16];        /* In network byte order. */
	u_int8_t  offset; 
	int       af;               /* AF_INET, AF_INET6 */
} owp_access_netmask;

typedef struct owp_kid_data {
	char passwd[OWP_HEX_PASSWD_LEN + 1];
	char class[OWP_MAX_CLASS_LEN + 1];
} owp_kid_data;

extern owp_tree_node_ptr owp_class2node(char *class, I2table hash);
extern char *ipaddr2class(u_int32_t ip, I2table ip2class_hash);
extern char *owp_kid2passwd(const char *kid, int len, policy_data* policy);
extern char *owp_kid2class(const char *kid, int len, policy_data* policy);
extern char *owp_sockaddr2class(struct sockaddr *addr, policy_data* policy);
extern void owp_print_ip2class_binding(const struct I2binding *p, FILE* fp);
extern void owp_print_strnet(owp_access_netmask *ptr, FILE* fp);
extern void owp_print_netmask(const I2datum *key, FILE* fp);
extern void owp_print_kid2data_binding(const struct I2binding *p, FILE* fp);
extern void print_class2limits_binding(const struct I2binding *p, FILE* fp);
extern void owp_print_class2node_binding(const struct I2binding *p, FILE* fp);
extern char *owamp_denumberize(unsigned long addr);
extern OWPBoolean owp_get_aes_key(void *app_data, const char *kid, \
	u_int8_t *key_ret, OWPErrSeverity	*err_ret);
extern OWPBoolean owp_check_control(void *app_data, OWPSessionMode mode, \
	const char *kid, struct sockaddr *local_sa_addr, \
	struct sockaddr	*remote_sa_addr, OWPErrSeverity	*err_ret);
extern OWPBoolean owp_check_test(void *app_data, OWPSessionMode	mode,
	const char *kid, OWPBoolean local_sender, 
	struct sockaddr *local_sa_addr, struct sockaddr	*remote_sa_addr,
	OWPTestSpec	*test_spec, OWPErrSeverity *err_ret);
extern unsigned long OWAMPGetBandwidth(owp_lim* lim);
extern unsigned long OWAMPGetSpace(owp_lim* lim);
extern unsigned long OWAMPGetNumSessions(owp_lim* lim);
extern I2datum* owp_raw2datum(const void *bytes, size_t len);
extern int owp_read_class2limits2(OWPContext ctx, const char *class2limits, \
		       policy_data* policy);
extern policy_data
*PolicyInit(
	OWPContext	ctx,
	char		*ip2class_file,
	char		*class2limits_file,
	char		*passwd_file,
	OWPErrSeverity	*err_ret
);

#endif	/* _owamp_contrib_h_ */
